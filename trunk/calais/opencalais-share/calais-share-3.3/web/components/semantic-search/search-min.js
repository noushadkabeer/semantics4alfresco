(function(){var Dom=YAHOO.util.Dom,Event=YAHOO.util.Event;var $html=Alfresco.util.encodeHTML;Alfresco.Search=function(htmlId){this.name="Alfresco.Search";this.id=htmlId;this.widgets={};this.modules={};Alfresco.util.ComponentManager.register(this);Alfresco.util.YUILoaderHelper.require(["button","container","datasource","datatable","json"],this.onComponentsLoaded,this);YAHOO.Bubbling.on("onSearch",this.onSearch,this);return this;};Alfresco.Search.prototype={options:{siteId:"",siteName:"",maxSearchResults:100,initialSearchTerm:"",initialSearchTag:"",initialSearchSemanticTag:"",initialSearchSemanticCategory:"",initialSearchAll:true,minSearchTermLength:1,maxSearchResults:100},widgets:null,modules:null,searchTerm:"",searchTag:"",searchSemanticTag:"",searchSemanticCategory:"",searchAll:true,resultsCount:0,hasMoreResults:false,setOptions:function Search_setOptions(obj){this.options=YAHOO.lang.merge(this.options,obj);return this;},setMessages:function Search_setMessages(obj){Alfresco.util.addMessages(obj,this.name);return this;},onComponentsLoaded:function Search_onComponentsLoaded(){Event.onContentReady(this.id,this.onReady,this,true);},onReady:function Search_onReady(){var toggleScopeLink=Dom.get(this.id+"-scope-toggle-link");Event.addListener(toggleScopeLink,"click",this.onToggleSearchScope,this,true);var uriSearchResults=Alfresco.constants.PROXY_URI+"semantics/search?";this.widgets.dataSource=new YAHOO.util.DataSource(uriSearchResults);this.widgets.dataSource.responseType=YAHOO.util.DataSource.TYPE_JSON;this.widgets.dataSource.connXhrMode="queueRequests";this.widgets.dataSource.responseSchema={resultsList:"items",fields:["nodeRef","type","name","displayName","description","modifiedOn","modifiedByUser","modifiedBy","size","title","browseUrl","site","tags"]};this._setupDataTable();YAHOO.Bubbling.fire("onSearch",{searchTerm:this.options.initialSearchTerm,searchTag:this.options.initialSearchTag,searchAll:(this.options.initialSearchAll=="true"),searchSemanticTag:this.options.initialSearchSemanticTag,searchSemanticCategory:this.options.initialSearchSemanticCategory});Alfresco.util.registerDefaultActionHandler(this.id,"search-tag","span",this);Alfresco.util.registerDefaultActionHandler(this.id,"search-scope-toggle","a",this);Dom.setStyle(this.id+"-body","visibility","visible");},_setupDataTable:function Search_setupDataTable(){var me=this;renderCellThumbnail=function Search_renderCellThumbnail(elCell,oRecord,oColumn,oData){oColumn.width=100;oColumn.height=100;Dom.setStyle(elCell.parentNode,"width",oColumn.width+"px");Dom.setStyle(elCell.parentNode,"height",oColumn.height+"px");Dom.setStyle(elCell.parentNode,"text-align","center");var url=me._getBrowseUrlForRecord(oRecord);var imageUrl=Alfresco.constants.URL_CONTEXT+"components/search/images/generic-result.png";switch(oRecord.getData("type")){case"document":imageUrl=Alfresco.constants.PROXY_URI+"api/node/"+oRecord.getData("nodeRef").replace(":/","");imageUrl+="/content/thumbnails/doclib?c=queue&ph=true";break;case"folder":imageUrl=Alfresco.constants.URL_CONTEXT+"components/search/images/folder.png";break;case"blogpost":imageUrl=Alfresco.constants.URL_CONTEXT+"components/search/images/blog-post.png";break;case"forumpost":imageUrl=Alfresco.constants.URL_CONTEXT+"components/search/images/topic-post.png";break;case"calendarevent":imageUrl=Alfresco.constants.URL_CONTEXT+"components/search/images/calendar-event.png";break;case"wikipage":imageUrl=Alfresco.constants.URL_CONTEXT+"components/search/images/wiki-page.png";break;case"link":imageUrl=Alfresco.constants.URL_CONTEXT+"components/search/images/link.png";break;}var name=oRecord.getData("displayName");var htmlName=$html(name);elCell.innerHTML='<span><a href="'+encodeURI(url)+'"><img src="'+imageUrl+'" alt="'+htmlName+'" title="'+htmlName+'" /></a></span>';};renderCellDescription=function Search_renderCellDescription(elCell,oRecord,oColumn,oData){Dom.setStyle(elCell.parentNode,"line-height","1.5em");var site=oRecord.getData("site");var url=me._getBrowseUrlForRecord(oRecord);var desc='<h3 class="itemname"><a href="'+encodeURI(url)+'" class="theme-color-1">'+$html(oRecord.getData("displayName"))+"</a></h3>";var txt=oRecord.getData("description");if(txt!==undefined&&txt!==""){desc+='<div class="details">'+$html(txt)+"</div>";}desc+='<div class="details">';var type=oRecord.getData("type");switch(type){case"document":case"folder":case"blogpost":case"forumpost":case"calendarevent":case"wikipage":case"link":desc+=me._msg("label."+type);break;default:desc+=me._msg("label.unknown");break;}desc+=" "+me._msg("message.insite");desc+=' <a href="'+Alfresco.constants.URL_PAGECONTEXT+"site/"+$html(site.shortName)+'/dashboard">'+$html(site.title)+"</a>";if(oRecord.getData("size")!==-1){desc+=" "+me._msg("message.ofsize");desc+=" "+Alfresco.util.formatFileSize(oRecord.getData("size"));}desc+=" "+me._msg("message.modifiedby");desc+=' <a href="'+Alfresco.constants.URL_PAGECONTEXT+"user/"+encodeURI(oRecord.getData("modifiedByUser"))+'/profile">'+$html(oRecord.getData("modifiedBy"))+"</a> ";desc+=me._msg("message.modifiedon");desc+=" "+Alfresco.util.formatDate(oRecord.getData("modifiedOn"));desc+="</div>";var tags=oRecord.getData("tags");if(tags.length!==0){var i,j;desc+='<div class="details"><span class="tags">'+me._msg("message.tags")+": ";for(i=0,j=tags.length;i<j;i++){desc+='<span id="'+me.id+"-searchByTag-"+$html(tags[i])+'"><a class="search-tag" href="#">'+$html(tags[i])+"</a> </span>";}desc+="</span></div>";}elCell.innerHTML=desc;};var columnDefinitions=[{key:"image",label:me._msg("message.preview"),sortable:false,formatter:renderCellThumbnail,width:100},{key:"summary",label:me._msg("message.desc"),sortable:false,formatter:renderCellDescription}];this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-results",columnDefinitions,this.widgets.dataSource,{renderLoopSize:32,initialLoad:false});this._setDefaultDataTableErrors(this.widgets.dataTable);if(this.options.initialSearchTerm.length===0&&this.options.initialSearchTag.length===0){this.widgets.dataTable.set("MSG_EMPTY","");}this.widgets.dataTable.doBeforeLoadData=function Search_doBeforeLoadData(sRequest,oResponse,oPayload){if(oResponse.error){try{var response=YAHOO.lang.JSON.parse(oResponse.responseText);me.widgets.dataTable.set("MSG_ERROR",response.message);}catch(e){me._setDefaultDataTableErrors(me.widgets.dataTable);}}else{if(oResponse.results){me.widgets.dataTable.set("MSG_EMPTY","");me.hasMoreResults=(oResponse.results.length>me.options.maxSearchResults);if(me.hasMoreResults){oResponse.results=oResponse.results.slice(0,me.options.maxSearchResults);}me.resultsCount=oResponse.results.length;me.renderLoopSize=Alfresco.util.RENDERLOOPSIZE;}}return true;};},_getBrowseUrlForRecord:function(oRecord){var url="#";if(oRecord.getData("browseUrl")!==undefined){var site=oRecord.getData("site");url=Alfresco.constants.URL_PAGECONTEXT+"site/"+site.shortName+"/"+oRecord.getData("browseUrl");}return url;},searchByTag:function Search_searchTag(param){this.refreshSearch({searchTag:param,searchTerm:""});},onToggleSearchScope:function Search_onToggleSearchScope(){var searchAll=!this.searchAll;this.refreshSearch({searchAll:searchAll});},refreshSearch:function Search_refreshSearch(args){var searchTerm=this.searchTerm;if(args.searchTerm!==undefined){searchTerm=args.searchTerm;}var searchTag=this.searchTag;if(args.searchTag!==undefined){searchTag=args.searchTag;}var searchAll=this.searchAll;if(args.searchAll!==undefined){searchAll=args.searchAll;}var url=Alfresco.constants.URL_CONTEXT+"page/";if(this.options.siteId.length!==0){url+="site/"+this.options.siteId+"/";}url+="search?t="+encodeURIComponent(searchTerm);url+="&tag="+encodeURIComponent(searchTag);url+="&a="+searchAll;window.location=url;},onSearch:function Search_onSearch(layer,args){var obj=args[1];if(obj!==null){var searchTerm=this.searchTerm;if(obj.searchTerm!==undefined){searchTerm=obj.searchTerm;}var searchTag=this.searchTag;if(obj.searchTag!==undefined){searchTag=obj.searchTag;}var searchAll=this.searchAll;if(obj.searchAll!==undefined){searchAll=obj.searchAll;}var searchSemanticTag=this.searchSemanticTag;if(obj.searchSemanticTag!==undefined){searchSemanticTag=obj.searchSemanticTag;}var searchSemanticCategory=this.searchSemanticCategory;if(obj.searchSemanticCategory!==undefined){searchSemanticCategory=obj.searchSemanticCategory;}this._performSearch(searchTerm,searchTag,searchAll,searchSemanticTag,searchSemanticCategory);}},_setDefaultDataTableErrors:function Search__setDefaultDataTableErrors(dataTable){var msg=Alfresco.util.message;dataTable.set("MSG_EMPTY",msg("message.empty","Alfresco.Search"));dataTable.set("MSG_ERROR",msg("message.error","Alfresco.Search"));},_performSearch:function Search__performSearch(searchTerm,searchTag,searchAll,searchSemanticTag,searchSemanticCategory){var searchTerm=YAHOO.lang.trim(searchTerm);var searchTag=YAHOO.lang.trim(searchTag);var searchSemanticTag=YAHOO.lang.trim(searchSemanticTag);var searchSemanticCategory=YAHOO.lang.trim(searchSemanticCategory);this.widgets.dataTable.deleteRows(0,this.widgets.dataTable.getRecordSet().getLength());this.widgets.dataTable.set("MSG_EMPTY","");this.widgets.dataTable.render();function successHandler(sRequest,oResponse,oPayload){this.searchTerm=searchTerm;this.searchTag=searchTag;this.searchSemanticTag=searchSemanticTag;this.searchSemanticCategory=searchSemanticCategory;this.searchAll=searchAll;this.widgets.dataTable.onDataReturnInitializeTable.call(this.widgets.dataTable,sRequest,oResponse,oPayload);this._updateSearchInfo();this._updateSearchScopeLink();}function failureHandler(sRequest,oResponse){if(oResponse.status==401){window.location.reload();}else{try{var response=YAHOO.lang.JSON.parse(oResponse.responseText);this.widgets.dataTable.set("MSG_ERROR",response.message);this.widgets.dataTable.showTableMessage(response.message,YAHOO.widget.DataTable.CLASS_ERROR);}catch(e){this._setDefaultDataTableErrors(this.widgets.dataTable);this.widgets.dataTable.render();}}}this.widgets.dataSource.sendRequest(this._buildSearchParams(searchAll,searchTerm,searchTag,searchSemanticTag,searchSemanticCategory),{success:successHandler,failure:failureHandler,scope:this});},_updateSearchInfo:function Search__updateSearchInfo(){var searchFor;if(this.searchTerm.length!==0){searchFor="<b>"+$html(this.searchTerm)+"</b>";}else{searchFor="<b>"+$html(this.searchTag)+"</b>";}var searchIn=(this.searchAll?this._msg("search.info.inallsites"):this._msg("search.info.insite","<b>"+$html(this.options.siteName)+"</b>"));var resultsCount="<b>"+this.resultsCount+"</b>";if(this.hasMoreResults){resultsCount=this._msg("search.info.morethan",resultsCount);}var text=this._msg("search.info.resultinfo",searchFor,searchIn,resultsCount);if(this.hasMoreResults){text+=" "+this._msg("search.info.onlyshowing",this.resultsCount);}Dom.get(this.id+"-search-info").innerHTML=text;},_updateSearchScopeLink:function Search__updateSearchScopeLink(){if(this.options.siteId===""){return;}var text=this.searchAll?this._msg("search.searchsiteonly",$html(this.options.siteName)):this._msg("search.searchall");var elem=Dom.get(this.id+"-scope-toggle-link");elem.innerHTML=text;var container=Dom.get(this.id+"-scope-toggle-container");Dom.removeClass(container,"hidden");},_buildSearchParams:function Search__buildSearchParams(searchAll,searchTerm,searchTag,searchSemanticTag,searchSemanticCategory){var site=searchAll?"":this.options.siteId;var params=YAHOO.lang.substitute("site={site}&term={term}&tag={tag}&semanticTag={semanticTag}&semanticCategory={semanticCategory}&maxResults={maxResults}",{site:encodeURIComponent(site),term:encodeURIComponent(searchTerm),tag:encodeURIComponent(searchTag),semanticTag:encodeURIComponent(searchSemanticTag),semanticCategory:encodeURIComponent(searchSemanticCategory),maxResults:this.options.maxSearchResults+1});return params;},_msg:function Search__msg(messageId){return Alfresco.util.message.call(this,messageId,"Alfresco.Search",Array.prototype.slice.call(arguments).slice(1));}};})();Alfresco.util.registerDefaultActionHandler=function(htmlId,className,ownerTagName,handlerObject){YAHOO.Bubbling.addDefaultAction(className,function genericDefaultAction(layer,args){var owner=YAHOO.Bubbling.getOwnerByTagName(args[1].anchor,ownerTagName);if(owner!==null){var tmp,parts,action,param;tmp=owner.id;if(tmp.indexOf(htmlId)!==0){return true;}tmp=tmp.substring(htmlId.length+1);parts=tmp.split("-");if(parts.length<1){return true;}action=parts[0];if(typeof handlerObject[action]=="function"){param=parts.length>1?tmp.substring(action.length+1):null;handlerObject[action].call(handlerObject,param);args[1].stop=true;}}return true;});};